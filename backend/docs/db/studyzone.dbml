// // Use DBML to define your database structure
// // Docs: https://dbml.dbdiagram.io/docs

// Table follows {
//   following_user_id integer
//   followed_user_id integer
//   created_at timestamp
// }

// Table users {
//   id integer [primary key]
//   username varchar
//   role varchar
//   created_at timestamp
// }

// Table posts {
//   id integer [primary key]
//   title varchar
//   body text [note: 'Content of the post']
//   user_id integer [not null]
//   status varchar
//   created_at timestamp
// }

// Ref user_posts: posts.user_id > users.id // many-to-one

// Ref: users.id < follows.following_user_id

// Ref: users.id < follows.followed_user_id

Project studyZone {
  database: "PostgresSQL"
}

Table users {
  id bigserial [pk] // Dùng bigserial/Long cho đồng nhất
  username varchar(255) [not null, unique]
  password varchar(255) [not null]

  total_point integer [default: 0]
  total_time integer [default: 0] // Đơn vị: giây

  imageUrl varchar(500)

  created_at timestamp [default: `now()`]
  updated_at timestamp
}

Table music {
  id bigserial [pk]
  name varchar(500) [not null]
  music_url varchar(500) [not null, unique] // URL thường dài, nên để 500

  duration integer [not null] // Giây
  required_point integer [default: 0]
  is_active boolean [default: true] // Dùng để ẩn/hiện bài hát hệ thống

  created_at timestamp [default: `now()`]
  updated_at timestamp
}

// Bảng trung gian thể hiện quan hệ Many-to-Many
Table music_saved {
  id bigserial [pk]
  user_id bigint [ref: > users.id] // Khóa ngoại chuẩn kiểu Long
  music_id bigint [ref: > music.id]

  archived_at timestamp [default: `now()`]

  Indexes {
    (user_id, music_id) [unique] // Ngăn một user lưu một bài hát 2 lần
  }
}

Table user_unlocked_music {
  id bigserial [pk]
  user_id bigint [ref: > users.id]
  music_id bigint [ref: > music.id]

  unlocked_at timestamp [default: `now()`]
  spent_points integer // Lưu lại số điểm tại thời điểm mua (để làm lịch sử giao dịch)

  Indexes {
    (user_id, music_id) [unique] // Không thể mở khóa 2 lần cho cùng 1 bài
  }
}

Table backgrounds {
  id bigserial [pk]

  name varchar(500) [not null, unique]

  backgroundUrl varchar(500) [not null, unique]

  required_points integer

  is_active boolean

  createdAt timestamp [default: `now()`]
  updatedAt timestamp
}

Table backgrounds_saved {
  id bigserial [pk]

  user_id bigint [ref: > users.id]
  background_id bigint [ref: > backgrounds.id]

  archivedAt timestamp [default: `now()`]
}

Table user_unlocked_backgrounds {
  id bigserial [pk]

  user_id bigint [ref: > users.id]
  background_id bigint [ref: > backgrounds.id]

  unlockedAt timestamp [default: `now()`]

  spent_points integer
}

Table study_sessions {
  id bigserial [pk]

  user_id bigint [ref: > users.id]

  start_time timestamp [default: `now()`]
  end_time timestamp

  points_earned integer [default: 0] // Điểm kiếm được trong phiên học này
}
